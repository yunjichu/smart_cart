<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í• ì¸ í–‰ì‚¬ ë“±ë¡</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        button {
            padding: 5px 10px;
        }
        input[type="number"] {
            width: 100px;
        }
    </style>
</head>
<body>
    <h1>í• ì¸ í–‰ì‚¬ ë“±ë¡</h1>
    <form id="discount-form">
        <label>ë¬¼í’ˆ ë²ˆí˜¸: <input type="text" id="product-id" required></label><br>
        <label>ì›ê°€ê²©(â‚©): <input type="number" id="original-price" required readonly></label><br>
        <label>í• ì¸ ê°€ê²©(â‚©): <input type="number" id="discount-price" required></label><br>
        <label>ì´ë²¤íŠ¸ ì‹œì‘ì¼: <input type="date" id="start-date" required></label><br>
        <label>ì´ë²¤íŠ¸ ì¢…ë£Œì¼: <input type="date" id="end-date" required></label><br><br>
        <p>í• ì¸ìœ¨: <span id="discount-percent">0%</span></p>
        <button type="submit">ë“±ë¡</button>
    </form>

    <h2>ë“±ë¡ëœ í• ì¸ í–‰ì‚¬ ëª©ë¡</h2>
    <table id="discount-table">
        <thead>
            <tr>
                <th>ë¬¼í’ˆ ë²ˆí˜¸</th>
                <th>ì›ê°€ê²©</th>
                <th>í• ì¸ ê°€ê²©</th>
                <th>í• ì¸ìœ¨</th>
                <th>ì´ë²¤íŠ¸ ê¸°ê°„</th>
                <th>ì‚­ì œ</th>
            </tr>
        </thead>
        <tbody>
            <!-- ë“±ë¡ëœ í• ì¸ í–‰ì‚¬ ëª©ë¡ -->
        </tbody>
    </table>

    <br>
    <a href="/">â† ë©”ì¸ í™”ë©´ìœ¼ë¡œ</a>

    <script>
        const form = document.getElementById("discount-form");
        const productIdInput = document.getElementById("product-id");
        const originalInput = document.getElementById("original-price");
        const discountInput = document.getElementById("discount-price");
        const discountPercent = document.getElementById("discount-percent");
        const tableBody = document.querySelector("#discount-table tbody");

        function updateDiscountPercent() {
            const original = parseFloat(originalInput.value);
            const discount = parseFloat(discountInput.value);
            if (!isNaN(original) && !isNaN(discount) && original > 0 && discount >= 0) {
                const percent = ((original - discount) / original) * 100;
                discountPercent.textContent = percent.toFixed(1) + "%";
            } else {
                discountPercent.textContent = "0%";
            }
        }

        originalInput.addEventListener("input", updateDiscountPercent);
        discountInput.addEventListener("input", updateDiscountPercent);

        // ğŸ”¹ ë¬¼í’ˆ ë²ˆí˜¸ ì…ë ¥ ì‹œ DBì—ì„œ ì›ê°€ê²© ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
        productIdInput.addEventListener("blur", () => {
            const productId = productIdInput.value.trim();
            if (!productId) return;

            fetch(`/api/item/${productId}`)
                .then(response => {
                    if (!response.ok) throw new Error("ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    return response.json();
                })
                .then(data => {
                    if (data.item_price !== undefined) {
                        originalInput.value = data.item_price;
                        updateDiscountPercent();
                    } else {
                        alert("í•´ë‹¹ ë¬¼í’ˆ ë²ˆí˜¸ì˜ ìƒí’ˆì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        originalInput.value = "";
                    }
                })
                .catch(error => {
                    console.error("Error fetching item info:", error);
                    alert("ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ì˜ëª»ëœ ë¬¼í’ˆ ë²ˆí˜¸ì…ë‹ˆë‹¤.");
                    originalInput.value = "";
                });
        });

        // ğŸ”¸ í¼ ì œì¶œ ì´ë²¤íŠ¸
        form.addEventListener("submit", function(event) {
            event.preventDefault();

            const productId = productIdInput.value;
            const original = parseFloat(originalInput.value);
            const discount = parseFloat(discountInput.value);
            const startDate = document.getElementById("start-date").value;
            const endDate = document.getElementById("end-date").value;

            if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) {
                alert("ì´ë²¤íŠ¸ ë‚ ì§œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            const period = `${startDate} ~ ${endDate}`;

            fetch('/api/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_num: productId,
                    origin_price: original,
                    event_price: discount,
                    event_period: period
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("í• ì¸ í–‰ì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    form.reset();
                    discountPercent.textContent = "0%";
                    loadEvents();
                } else {
                    alert("ë“±ë¡ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                }
            })
            .catch(error => {
                alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
                console.error("Error:", error);
            });
        });

        // ğŸ”¹ ë“±ë¡ëœ ì´ë²¤íŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadEvents() {
            fetch('/api/events')
                .then(response => response.json())
                .then(data => {
                    tableBody.innerHTML = '';
                    data.forEach(event => {
                        const original = event.item_price;
                        const discount = event.event_price;
                        const percent = ((original - discount) / original) * 100;

                        const newRow = document.createElement("tr");
                        newRow.innerHTML = `
                            <td>${event.item_num}</td>
                            <td>â‚©${original.toLocaleString()}</td>
                            <td>â‚©${discount.toLocaleString()}</td>
                            <td>${percent.toFixed(1)}%</td>
                            <td>${event.event_period}</td>
                            <td><button onclick="deleteEvent('${event.item_num}')">ì‚­ì œ</button></td>
                        `;
                        tableBody.appendChild(newRow);
                    });
                })
                .catch(error => {
                    console.error("Error loading events:", error);
                });
        }

        // ğŸ”¸ ì‚­ì œ ê¸°ëŠ¥
        function deleteEvent(itemNum) {
            if (confirm('ì´ í• ì¸ í–‰ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch(`/api/events/${itemNum}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            loadEvents();
                        } else {
                            alert("ì‚­ì œ ì‹¤íŒ¨");
                        }
                    })
                    .catch(error => {
                        console.error("Error deleting event:", error);
                    });
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ í• ì¸ ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = loadEvents;
    </script>
</body>
</html>
